### 我为什么读这本书？

![](media_networkConnect/封面.png)



### 为什么分享这个？

1. 对以前知识的回顾；
3. 与大家一起分享我的阅读收获；
3. 对以前不懂的地方、理解错误的地方与大家一起学习探讨；



### 从几个问题开始？

1. 在浏览器输入 www.baidu.com 是如何获取到数据的？
2. DNS是什么？
3. Socket是什么？
5. HTTP返回的状态码又是什么意思？比如：200，404，500。



###  URL

统一资源定位系统（uniform resource locator;URL）是因特网的万维网服务程序上用于指定信息位置的表示方法。



1、浏览器输入URL

>https://www.baidu.com



2、首先根据HTTP的规则，解析URL

>  https://username:password@www.qycloud.com:80/index.html
>
> ftp://username:password@ftp.class.com:21/dir/index.html
>
> file://localhost/....

> 协议 + 用户名、密码 + 服务器名 + 端口号 + 数据源路径



3、几种URL

> https://www.baidu.com
>
> https://www.baidu.com/
>
> https://www.baidu.com/index.html
>
> https://www.baidu.com/default.html
>
> https://www.baidu.com/search/error.html



### IP

>  IP地址 = 网络号 + 主机号
>
> "网络号"对应的号码是分配给整个子网的，而"主机号"对应的号码是分配给子网中的计算机。

IP地址是一串32比特(bit)的数字，按照8bit=1byte(字节)为一组分成4组，分别用十进制表示。

eg: 

![](media_networkConnect/IP地址.png)



**子网掩码** 就是来区别网络地址和主机地址的。



绝大多数的IP地址都是公有地址，需要向国际互联网信息中心申请注册。

但是在IPv4地址协议中预留了3个IP地址段，作为私有地址，供组织机构内部使用。



但内网要想和外部Internet链接就需要转换成公网唯一IP与外部链接，需要使用路由NAT转换。
NAT（Network Address Translation，网络地址转换）。



> 10.11.12.0 / 255.255.255.0
>
> * 主机号部分都为0，这个地址不是代表某台计算机，而且代表整个子网。
>
> 10.11.12.1 / 255.255.255.0
>
> * 主机号部分都为1，这个地址表示对整个子网进行广播。



### DNS

DNS：域名系统（Domain Name System缩写），将域名和IP地址相互映射的一个分布式数据库，



域名解析网站：https://tool.chinaz.com/dns/



问：为什么需要DNS解析域名为IP地址？

1. 网络通讯大部分是基于TCP/IP的，而TCP/IP是基于IP地址的，所以计算机在网络上进行通讯时只能识别如“202.96.134.133”之类的IP地址，而不能认识域名。

2. 能够使人更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。



问：浏览器如何想DNS服务器发送查询请求？

向 DNS服务器发出查询，也就是向DNS服务器发送查询消息，并接收服务器返回的响应消息。换句话说，对于 DNS服务器，我们的计算机上一定有相应的 DNS客户端，而相当于 DNS客户端的部分称为 `DNS解析器`，或者简称`解析器`。通过 DNS查询 IP地址的操作称为`域名解析`。



问：那么DNS解析器在哪？

这里就得提到库，其中Socket库也是一种库，是用于调用网络功能的程序组件集合。其中包含的程序组件可以让其他的应用程序调用操作系统的网络功能 ，而`解析器`就是这个库中的其中一种程序组件。

```
#include <sys/socket.h>
```

根据域名查询 IP地址时，浏览器会使用 Socket库中的解析器。

调用解析器后，解析器会向 DNS服务器发送查询消息，然后DNS服务器会返回响应消息。响应消息中包含查询到的IP地址，解析器会取出 IP地址，并将其写入浏览器指定的内存地址中。只要运行图 1.11中的这一行程序，就可以完成前面所有这些工作，我们也就完成了IP地址的查询。接下来，浏览器在向 Web服务器发送消息时，只要从该内存地址取出 IP地址，并将它与HTTP请求消息一起交给操作系统就可以了。

![](media_networkConnect/DNS请求函数.png)



![](media_networkConnect/DNS请求流程.png)



问：既然这是个请求，那又是如何获取DNS服务器IP地址？

如果不配置，则会使用路由器的DNS，若配置，则使用我们配置的。

![](media_networkConnect/路由器配置.png)



问：如何查看本地使用的DNS地址？

方法一：nslookup、网络实用工具

```
$ ~ nslookup www.baidu.com
Server:		114.114.114.114
Address:	114.114.114.114#53

Non-authoritative answer:
www.baidu.com	canonical name = www.a.shifen.com.
Name:	www.a.shifen.com
Address: 61.135.169.125
Name:	www.a.shifen.com
Address: 61.135.169.121
```

方法二：查看配置文件

```
$ ~ cat /etc/resolv.conf
#
# macOS Notice
#
# This file is not consulted for DNS hostname resolution, address
# resolution, or the DNS query routing mechanism used by most
# processes on this system.
#
# To view the DNS configuration used by this system, use:
#   scutil --dns
#
# SEE ALSO
#   dns-sd(1), scutil(8)
#
# This file is automatically generated.
#
nameserver 114.114.114.114
```



问：如何在数万DNS服务器中找到目标DNS服务器？

1. 域名层级

   根域 - > 顶级域（com,cn,jp,net,org,edu,gov,mil,hk）-> 二级域（com.cn,edu.cn）

2. 根域的 DNS服务器中保管着 com、 jp等的 DNS服务器的信息。由于上级 DNS服务器保管着所有下级 DNS服务器的信息，所以我们可以从根域开始一路往下顺藤摸瓜找到任意一个域的 DNS服务器。

3. 那就是将根域的 DNS服务器信息保存在互联网中所有的 DNS服务器中。这样一来，任何 DNS服务器就都可以找到并访问根域 DNS服务器了。因此，客户端只要能够找到任意一台 DNS服务器，就可以通过它找到根域 DNS服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS服务器。分配给根域 DNS服务器的 IP地址在全世界仅有 13个，而且这些地址几乎不发生变化，因此将这些地址保存在所有的 DNS服务器中也并不是一件难事。

![](media_networkConnect/查找目标DNS服务器.png)





### 创建Socket连接服务器



![](media_networkConnect/HTTP请求流程.png)



```
#include <sys/socket.h>
创建Socket
int tcp_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);  //IPPROTO_TCP表示TCP协议
int udp_socket = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);  //IPPROTO_UDP表示UDP协议
连接Socket
int connect(int sockfd, const struct sockaddr* servaddr, socklen_t addrlen); // 返回：成功为0，出错-1
write()
Read()
Close()
```



WebSocket



TCP的三次握手、四次挥手

问：为什么需要“三次握手”?

> **为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。**

问：为什么要四次挥手？

> 由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。

问：为什么要等待2MSL？

MSL：报文段最大生存时间，它是任何报文段被丢弃前在网络内的最长时间。

### 数据包

![](media_networkConnect/包.png)

![](media_networkConnect/大包拆分.png)





![](media_networkConnect/包传递流程.png)





**IP模块负责添加如下两个头部：**

**（1）IP头部： IP用的头部，包含 IP地址。IP头部中包含 IP协议规定的、根据 IP地址将包发往目的地所需的控制信息；**

**（2）MAC头部：以太网用的头部，包含 MAC地址。MAC头部包含通过以太网的局域网将包传输至最近的路由器所需的控制信息。**





1. 路由器是按照IP规则传输包的设备，集线器、交换机是按照以太网规则传输包的设备。
2. MAC头部用于以太网协议，IP头部用于IP协议。
3. IP协议先根据IP头部找到下一个路由器的位置，然后IP协议会查找下一个路由器的MAC地址，并将这个地址写入MAC头部(这样以太网协议就知道包要发送到哪个路由器了)，再委托以太网协议传输包。





问：如何获取局域网内路由器的MAC地址？

ARP协议













| **OSI七层网络模型（Open System Interconnect）** | **TCP/IP网络模型** | **对应网络协议**           |
| ----------------------------------------------- | ------------------ | -------------------------- |
| 应用层（Application）                           |                    | HTTP、FTP、TFTP、SMTP、NFS |
| 表示层（Presentation）                          | 应用层             |                            |
| 会话层（Session）                               |                    | SMTP、DNS                  |
| 传输层（Transport）                             | 传输层             | TCP、UDP                   |
| 网络层（Network）                               | 网络层             | IP、ARP、ICMP              |
| 数据链路层（Data Link）                         | 数据链路层         |                            |
| 物理层（Physical）                              | 物理层             |                            |



![](media_networkConnect/HTTP返回状态.png)







### 不解

整个流程还不能完全跑通，依旧存在很多关节点想不通，希望能够与大家进行探讨学习。

比如：对整个网络架构不了解，从而对内部数据传递也不懂。特别是路由器、交换机、集线器如何转发的消息的还是一知半解。







### 学以致用

1. 网络请求：404、500，我们就可以简单判断是客户端还是服务器的原因了。
2. 网络优化？可以从 DNS 角度进行优化。
3. 可以简单的组建网络。
4. 可以使用Socket库，写一个QQ聊天工具。







